# deploy iexec-oracle on rsk



# A Regtest 
# A-1 prepare your regtest.conf with your wallet

In order to run the smart contract on RegTest network, download everything from https://github.com/rsksmart/artifacts using the command: 

git clone https://github.com/rsksmart/artifacts.git

Go to the folder artifacts, then go to /Dockerfiles/RSK-Node/, type in:

docker build -t regtest -f Dockerfile.RegTest .

Then:

docker run -d --name regtest-node-01  -p 4444:4444 -p 30305:30305 regtest

This will build a RegTest container for you. The purpose of building this container is to download a file, then modify it. Right now, type in:

docker ps

This will show you the last container ID, if your computer has been turned off for whatever reason after you ran the container, type in:

docker ps -a

This will display all the container currently running, the top one is the one you have just created.

Now type in:

docker exec -it <container_id> bash

Then:

cat /etc/rsk/regtest.conf 

You will see the regtest.conf, copy the whole document and create your own regtest.conf in the local path /Dockerfiles/RSK-Node/, then paste the document in it.

Inside the regtest.conf you will find the wallet:

wallet { 
   accounts = []
} 

Modify it like this and save it:

wallet { 
   enabled = true,
   accounts = [
       {
           "publicKey" : "YOUR_WALLET_PUBLIC_KEY",
           "privateKey" : "YOUR_WALLET_PRIVATE_KEY"
       }
   ]
}


# A-2 build your regtest docker image with your owned regtest.conf

In the path /Dockerfiles/RSK-Node/, you will find the following lines:

# Supervisod CONF
COPY supervisord.conf /etc/supervisor/conf.d/supervisord.conf

add the following line after it:

COPY regtest.conf /etc/rsk/regtest.conf

# A-3 run and check your regtest docker container and check your wallet is active

Like what you have done in the A-1, go to the path artifacts, then go to /Dockerfiles/RSK-Node/, type in:

docker build -t regtest -f Dockerfile.RegTest .

Then:

docker run -d --name regtest-node-01  -p 4444:4444 -p 30305:30305 regtest

docker ps

Again, you have the container ID, this time, type in the following command to see if the container is well started:

docker logs -f <CONTAINER ID>

If you see line like this:

2018-02-16 15:45:56,425 INFO success: rsk entered RUNNING state, process has stayed up for > than 1 seconds (startsecs)

This means it is functioning properly.

# A-4 add rsk conf into the truffle.js

In the root folder of the contract, you can find a file "truffle.js",  add the description of the network in the networks{} like this:

module.exports = {
  networks: {
    ...
    rsk: {
      host: "localhost",
      port: 4444,
      network_id: "*" // Match any network id
      from: "WALLET_PUBLIC_KEY"(wallet with money),
      gasPrice: 1, 
      gas: 250000,
    },
    solc: {
        optimizer: {
            enabled: true,
            runs: 200
        }
    },
    ...
  }
};


# A-5 modify the usage of gas

In the folder migrations, you can find two files: 1_initial_migration.js and 2_deploy_contracts.js. You need to modifiy them.

In these two files, you will find these following lines:

deployer.deploy(Migrations, {gas: 500000});
return deployer.deploy(RLC)
.then(() => deployer.deploy(IexecOracleEscrow, rlcInstance.address))
return deployer.deploy(IexecOracle, instance.address, '7000000000000000') 

In the first deployer.deploy(), there is an input {gas: 500000}, now you need to have that in the other three. However, the parameter for the gas is different for each of them. As these represent the gas that will be spent, it is strongly suggested that you use the exact amount of gas that will cost.

First, you need to run the ganache-cli, if you haven't install it, open a terminal and type in:

npm install -g ganache-cli

To run it, type in:

ganache-cli.

In the root folder of your contract, open another terminal and type in:

truffle migrate

This will deploy your contract in the development network, and you can see the transaction of each step, deploying one part will take more than one contract to do it. Now in the previous terminal running the ganache-cli you are able to see the transactions of the deploying of the contract, each transanction has a gas usage. group these transactions by the deployment and find out the largest gas usage of each deployment and put them in the input of the deployer.deploy(), you should be able to get these following lines:

deployer.deploy(Migrations, {gas: 269607});
return deployer.deploy	(RLC, {gas: 1618444})
.then(() => deployer.deploy(IexecOracleEscrow, rlcInstance.address, {gas: 779576}))
return deployer.deploy(IexecOracle, instance.address, '7000000000000000', {gas: 3271289});

Notice that the gas usage cannot be smaller than these, however, up to 1.2 times the gas usage have been prove to be feasible.

# A-6 truffle compile and migrate smart contract into regtest rsk

In the root of your contract, open a terminal. In order to compile the contract, type in:

truffle compile 

To deploy the contract on the regtest, type in:

truffle migrate --network rsk

Notice that if you haven't compiled the contract, this will compile the contract automatically, then deploy it. If you have modified your contract, you can re-upload your smart contract by typing in:

truffle migrate --network rsk --reset

After a successful migration, you will see Saving successful migration to network.., now type in:

truffle console --network rsk

This opens a truffle console in the development network for you.

In the console, in order to get a contract reference, type in:

<contract name>.deployed()

For example RLC.deployed()

You can monitor the syncing by type in:

web3.eth.syncing

you will see { startingBlock: 0, currentBlock: 177, highestBlock: 574 } which indicates the syncing of the node or false if the node is already synced.

After having deployed, you can check the accounts by typing in:

web3.eth.coinbase

The command web3.eth.coinbase gives you the address of your current account. Or you can use web3.eth.accounts to get the wallet in the contract, it is an array so account[#] is allowed as well.

web3.eth.getBalance("YOUR_WALLET_PUBLIC_KEY").toNumber()

This will show you how much money you have.


# B TestNet 

These following parts are similiar to those of the RegTest.

# B-1 prepare your testnet.conf with your wallet

Like what has been done for the RegTest.conf, go to /Dockerfiles/RSK-Node/, type in:

docker build -t testnet -f Dockerfile.TestNet .

Then:

docker run -d --name testnet-node-01  -p 4444:4444 -p 50505:50505 testnet

Again, you need to get the container id and type in:

docker exec -it <container_id> bash

Then:

cat /etc/rsk/testnet.conf 

Create your own testnet.conf like what you have done for the regtest.conf, modify the wallet the same way.

# B-2 build your testnet docker image with your owned testnet.conf 

It's the same as # A-2, in the path /Dockerfiles/RSK-Node/, you will find the following lines:

# Supervisod CONF
COPY supervisord.conf /etc/supervisor/conf.d/supervisord.conf

add the following line after it:

COPY testnet.conf /etc/rsk/testnet.conf

# B-3 run and check your testnet docker container and check your wallet is active

Like what you have done in the A-3, go to the path artifacts, then go to /Dockerfiles/RSK-Node/, type in:

docker build -t testnet -f Dockerfile.TestNet .

Then:

docker run -d --name testnet-node-01  -p 4444:4444 -p 50505:50505 testnet

Then do the same as in A-3

# B-4 add rsk conf into the truffle.js

The same as in A-4

# B-5 truffle compile and migrate smart contract into testnet rsk

The same as in A-5.
